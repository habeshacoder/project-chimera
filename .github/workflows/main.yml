name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest  # Cross-platform, but Windows-compatible build

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install uv
      run: pip install uv

    - name: Setup env
      run: make setup

    - name: Run Tests
      run: make test  # Failing tests OK

    - name: Lint
      run: |
        pip install ruff
        ruff check .

    - name: Security Check
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        format: 'table'
        exit-code: '1'  # Fail on critical vulns

    - name: AI Review Policy (Simulate CodeRabbit)
      run: echo "Check specs alignment and security"  # Placeholder; integrate CodeRabbit via .coderabbit.yaml if needed